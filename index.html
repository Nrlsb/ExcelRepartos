<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilla de Repartos Optimizada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        input:read-only {
            background-color: #f3f4f6; /* bg-gray-100 */
            cursor: not-allowed;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show {
            opacity: 1;
            bottom: 40px;
        }
        .toast.error { background-color: #ef4444; } /* bg-red-500 */
        .toast.success { background-color: #22c55e; } /* bg-green-500 */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8">
        
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Planilla de Repartos en Tiempo Real</h1>
            <p class="mt-2 text-gray-600">Agrega, edita o elimina repartos. Los cambios se reflejarán para todos al instante.</p>
        </header>

        <!-- Add Reparto Form -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <h2 class="text-2xl font-semibold mb-4">Agregar Nuevo Reparto</h2>
            <form id="add-reparto-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="destino" placeholder="Destino" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                <input type="text" id="direccion" placeholder="Dirección" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                <input type="text" id="horario" placeholder="Horario de entrega" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                <input type="number" id="bultos" placeholder="Cantidad de bultos" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                <button type="submit" class="md:col-span-2 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                    Agregar Reparto
                </button>
            </form>
        </div>
        
        <!-- Controls Bar -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
             <div id="initial-data-loader">
                 <button id="load-initial-data-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-300 text-sm">
                    Cargar Datos de Ejemplo
                </button>
            </div>
            <div class="flex items-center gap-4">
                <button id="export-excel-btn" class="bg-emerald-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-emerald-700 transition duration-300 flex items-center gap-2 shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                    Exportar a Excel
                </button>
                <button id="clear-all-btn" class="bg-red-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-red-700 transition duration-300 flex items-center gap-2 shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    Vaciar Planilla
                </button>
            </div>
        </div>

        <!-- Repartos Table -->
        <div class="bg-white p-4 rounded-xl shadow-lg overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3">N°</th>
                        <th scope="col" class="px-6 py-3">Destino</th>
                        <th scope="col" class="px-6 py-3">Dirección</th>
                        <th scope="col" class="px-6 py-3">Horario de entrega</th>
                        <th scope="col" class="px-6 py-3 text-center">Bultos</th>
                        <th scope="col" class="px-6 py-3 text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="repartos-table-body">
                    <!-- Rows will be inserted here dynamically -->
                </tbody>
            </table>
            <div id="loading-state" class="text-center p-8">
                <p class="text-gray-500">Cargando datos...</p>
            </div>
        </div>

        <!-- Edit Reparto Modal -->
        <div id="edit-modal" class="modal-backdrop hidden">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 md:w-2/3 lg:w-1/2 relative">
                <h2 class="text-2xl font-semibold mb-6">Editar Reparto</h2>
                <form id="edit-reparto-form">
                    <input type="hidden" id="edit-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-numero" class="block mb-2 text-sm font-medium text-gray-900">N° (No editable)</label>
                            <input type="text" id="edit-numero" class="p-3 border rounded-lg w-full" readonly>
                        </div>
                        <div>
                            <label for="edit-destino" class="block mb-2 text-sm font-medium text-gray-900">Destino</label>
                            <input type="text" id="edit-destino" class="p-3 border rounded-lg w-full" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="edit-direccion" class="block mb-2 text-sm font-medium text-gray-900">Dirección</label>
                            <input type="text" id="edit-direccion" class="p-3 border rounded-lg w-full" required>
                        </div>
                         <div>
                            <label for="edit-horario" class="block mb-2 text-sm font-medium text-gray-900">Horario de entrega</label>
                            <input type="text" id="edit-horario" class="p-3 border rounded-lg w-full" required>
                        </div>
                        <div>
                            <label for="edit-bultos" class="block mb-2 text-sm font-medium text-gray-900">Cantidad de bultos</label>
                            <input type="number" id="edit-bultos" class="p-3 border rounded-lg w-full" required>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-4">
                        <button type="button" id="cancel-edit-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast-notification" class="toast"></div>
    </div>

    <footer class="text-center p-4 text-sm text-gray-500">
        <p>Para compartir, solo envía la URL de esta página a otros usuarios.</p>
        <p class="font-mono mt-2 text-xs">ID de la App: <span id="app-id-display"></span></p>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, writeBatch, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /**
         * ----------------------------------------------------------------
         * APP MODULE
         * ----------------------------------------------------------------
         * This self-invoking function encapsulates the entire application
         * logic to avoid polluting the global scope and to organize
         * the code in a modular and maintainable way.
         */
        (async function App() {

            // --- 1. CONFIGURATION AND STATE ---
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
  apiKey: "AIzaSyDCoPsrT6fLTTnvUtBSgYfB9mBM0rfiEi0",
  authDomain: "mis-repartos-a04f2.firebaseapp.com",
  projectId: "mis-repartos-a04f2",
  storageBucket: "mis-repartos-a04f2.firebasestorage.app",
  messagingSenderId: "752024988115",
  appId: "1:752024988115:web:ee9240e0b2f9a56d2be726",
  measurementId: "G-7HZ8DR5VTC"
};
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'repartos-app-default';
            let repartosCache = []; // Local cache for repartos data

            // --- 2. DOM ELEMENT SELECTORS ---
            const DOMElements = {
                app: document.getElementById('app'),
                appIdDisplay: document.getElementById('app-id-display'),
                addForm: document.getElementById('add-reparto-form'),
                tableBody: document.getElementById('repartos-table-body'),
                loadingState: document.getElementById('loading-state'),
                initialDataLoader: document.getElementById('initial-data-loader'),
                loadInitialDataBtn: document.getElementById('load-initial-data-btn'),
                exportBtn: document.getElementById('export-excel-btn'),
                clearAllBtn: document.getElementById('clear-all-btn'),
                editModal: {
                    container: document.getElementById('edit-modal'),
                    form: document.getElementById('edit-reparto-form'),
                    id: document.getElementById('edit-id'),
                    numero: document.getElementById('edit-numero'),
                    destino: document.getElementById('edit-destino'),
                    direccion: document.getElementById('edit-direccion'),
                    horario: document.getElementById('edit-horario'),
                    bultos: document.getElementById('edit-bultos'),
                    cancelBtn: document.getElementById('cancel-edit-btn')
                },
                toast: document.getElementById('toast-notification')
            };

            // --- 3. FIREBASE INITIALIZATION AND AUTHENTICATION ---
            let db;
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                DOMElements.app.innerHTML = `<div class="text-center text-red-500">Error crítico: La aplicación no puede conectarse a la base de datos.</div>`;
                return; // Stop execution if Firebase fails
            }
            
            const repartosCollectionRef = collection(db, `artifacts/${appId}/public/data/repartos`);
            DOMElements.appIdDisplay.textContent = appId;


            // --- 4. UI HELPER FUNCTIONS ---

            /**
             * Shows a toast notification message.
             * @param {string} message The message to display.
             * @param {'success'|'error'} type The type of toast.
             */
            function showToast(message, type = 'success') {
                DOMElements.toast.textContent = message;
                DOMElements.toast.className = `toast ${type} show`;
                setTimeout(() => {
                    DOMElements.toast.className = `toast ${type}`;
                }, 3000);
            }

            /**
             * Renders the repartos data into the HTML table.
             * It clears the existing table body and rebuilds it.
             * @param {Array<Object>} repartos Array of reparto objects.
             */
            function renderTable(repartos) {
                DOMElements.tableBody.innerHTML = ''; // Clear table for re-render
                if (repartos.length === 0) {
                    DOMElements.loadingState.innerHTML = '<p class="text-gray-500">No hay repartos. Agrega uno nuevo o carga los datos de ejemplo.</p>';
                    DOMElements.loadingState.style.display = 'block';
                    DOMElements.initialDataLoader.style.display = 'block';
                } else {
                    DOMElements.loadingState.style.display = 'none';
                    DOMElements.initialDataLoader.style.display = 'none';
                    repartos.forEach(reparto => {
                        const row = DOMElements.tableBody.insertRow();
                        row.className = 'bg-white border-b hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium text-gray-900">${reparto.N || ''}</td>
                            <td class="px-6 py-4">${reparto.Destino || ''}</td>
                            <td class="px-6 py-4">${reparto.Direccion || ''}</td>
                            <td class="px-6 py-4">${reparto.Horario || ''}</td>
                            <td class="px-6 py-4 text-center font-semibold">${reparto.Bultos || 0}</td>
                            <td class="px-6 py-4 text-center">
                                <button data-id="${reparto.id}" class="edit-btn text-blue-600 hover:text-blue-900 font-medium mr-3">Editar</button>
                                <button data-id="${reparto.id}" class="delete-btn text-red-600 hover:text-red-900 font-medium">Eliminar</button>
                            </td>
                        `;
                    });
                }
            }

            /**
             * Opens the edit modal and populates it with data from the selected reparto.
             * @param {string} id The ID of the reparto to edit.
             */
            function openEditModal(id) {
                const reparto = repartosCache.find(r => r.id === id);
                if (!reparto) {
                    showToast("No se pudo encontrar el reparto para editar.", "error");
                    return;
                }
                const { editModal } = DOMElements;
                editModal.id.value = id;
                editModal.numero.value = reparto.N;
                editModal.destino.value = reparto.Destino;
                editModal.direccion.value = reparto.Direccion;
                editModal.horario.value = reparto.Horario;
                editModal.bultos.value = reparto.Bultos;
                editModal.container.classList.remove('hidden');
            }
            
            /** Closes the edit modal. */
            function closeEditModal() {
                DOMElements.editModal.container.classList.add('hidden');
            }


            // --- 5. DATA (CRUD) & BUSINESS LOGIC FUNCTIONS ---

            /**
             * Fetches and listens for real-time updates on the repartos collection.
             */
            function listenForRepartos() {
                onSnapshot(repartosCollectionRef, (snapshot) => {
                    repartosCache = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    repartosCache.sort((a, b) => (a.N || "").localeCompare(b.N || "", undefined, { numeric: true }));
                    renderTable(repartosCache);
                }, (error) => {
                    console.error("Error listening for real-time updates:", error);
                    showToast("Error de conexión con la base de datos.", "error");
                    DOMElements.loadingState.innerHTML = '<p class="text-red-500">Error al cargar los datos. Revisa la consola.</p>';
                });
            }

            /**
             * Handles the submission of the "add reparto" form.
             * @param {Event} e The form submission event.
             */
            async function handleAddReparto(e) {
                e.preventDefault();
                const form = e.target;
                
                // Auto-increment logic
                const maxN = repartosCache.reduce((max, r) => Math.max(max, parseInt(r.N, 10) || 0), 0);
                const nextN = (maxN + 1).toString();

                const newReparto = {
                    N: nextN,
                    Destino: form.destino.value,
                    Direccion: form.direccion.value,
                    Horario: form.horario.value,
                    Bultos: Number(form.bultos.value),
                };

                try {
                    await addDoc(repartosCollectionRef, newReparto);
                    showToast("Reparto agregado con éxito.", "success");
                    form.reset();
                } catch (error) {
                    console.error("Error adding document: ", error);
                    showToast("Error al guardar el reparto.", "error");
                }
            }

            /**
             * Handles the submission of the "edit reparto" form.
             * @param {Event} e The form submission event.
             */
            async function handleEditReparto(e) {
                e.preventDefault();
                const { editModal } = DOMElements;
                const id = editModal.id.value;
                const updatedData = {
                    N: editModal.numero.value, // Keep the original number
                    Destino: editModal.destino.value,
                    Direccion: editModal.direccion.value,
                    Horario: editModal.horario.value,
                    Bultos: Number(editModal.bultos.value),
                };
                
                try {
                    await updateDoc(doc(db, repartosCollectionRef.path, id), updatedData);
                    showToast("Reparto actualizado.", "success");
                    closeEditModal();
                } catch (error) {
                    console.error("Error updating document: ", error);
                    showToast("Error al guardar los cambios.", "error");
                }
            }

            /**
             * Deletes a single reparto document from Firestore.
             * @param {string} id The ID of the reparto to delete.
             */
            async function deleteReparto(id) {
                if (!confirm('¿Estás seguro de que quieres eliminar este reparto?')) return;
                try {
                    await deleteDoc(doc(db, repartosCollectionRef.path, id));
                    showToast("Reparto eliminado.", "success");
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    showToast("Error al eliminar el reparto.", "error");
                }
            }
            
            /**
             * Deletes all repartos from the collection.
             */
            async function clearAllRepartos() {
                if (repartosCache.length === 0) {
                    showToast("La planilla ya está vacía.", "error");
                    return;
                }
                if (!confirm("¿Estás seguro de que quieres eliminar TODOS los repartos? Esta acción no se puede deshacer.")) return;
                
                try {
                    const batch = writeBatch(db);
                    repartosCache.forEach(reparto => batch.delete(doc(repartosCollectionRef, reparto.id)));
                    await batch.commit();
                    showToast("Todos los repartos han sido eliminados.", "success");
                } catch (error) {
                    console.error("Error clearing all documents: ", error);
                    showToast("Ocurrió un error al vaciar la planilla.", "error");
                }
            }
            
            /**
             * Exports the current table data to an Excel file with a custom header.
             */
            function exportToExcel() {
                if (repartosCache.length === 0) {
                    showToast("No hay datos para exportar.", "error");
                    return;
                }
                
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet([[]]);

                // Add custom header
                XLSX.utils.sheet_add_aoa(worksheet, [
                    ['mercurio', 'REPARTOS', null, null, 'RG-031'],
                    [null, null, null, null, 'REV 00'], [],
                    [null, 'Sucursal que solicita el Reparto:'],
                    [null, 'Fecha:', new Date().toLocaleDateString('es-AR')], []
                ], { origin: 'A1' });

                // Merge title cells
                worksheet['!merges'] = [{ s: { r: 0, c: 1 }, e: { r: 0, c: 3 } }];

                // Add table data
                const tableHeaders = ['N°', 'Destino', 'Dirección', 'Horarios de entrega', 'Cantidad de Bultos'];
                const tableData = repartosCache.map(r => [r.N, r.Destino, r.Direccion, r.Horario, r.Bultos]);
                XLSX.utils.sheet_add_aoa(worksheet, [tableHeaders], { origin: 'A7' });
                XLSX.utils.sheet_add_aoa(worksheet, tableData, { origin: 'A8' });
                
                // Set column widths
                worksheet['!cols'] = [{ wch: 8 }, { wch: 35 }, { wch: 40 }, { wch: 25 }, { wch: 20 }];

                XLSX.utils.book_append_sheet(workbook, worksheet, 'Repartos');
                XLSX.writeFile(workbook, 'Planilla_de_Repartos.xlsx');
            }


            // --- 6. EVENT LISTENERS ---

            // Form Submissions
            DOMElements.addForm.addEventListener('submit', handleAddReparto);
            DOMElements.editModal.form.addEventListener('submit', handleEditReparto);

            // Button Clicks
            DOMElements.exportBtn.addEventListener('click', exportToExcel);
            DOMElements.clearAllBtn.addEventListener('click', clearAllRepartos);
            DOMElements.editModal.cancelBtn.addEventListener('click', closeEditModal);

            // Event delegation for table actions
            DOMElements.tableBody.addEventListener('click', (e) => {
                const { target } = e;
                const id = target.dataset.id;
                if (!id) return;
                
                if (target.classList.contains('edit-btn')) openEditModal(id);
                if (target.classList.contains('delete-btn')) deleteReparto(id);
            });
            
            // Initial Data Loader
             DOMElements.loadInitialDataBtn.addEventListener('click', async () => {
                if (repartosCache.length > 0) {
                     showToast("La planilla ya tiene datos.", "error");
                     return;
                }
                const initialData = [
                    { N: "1", Destino: "Ferretería El Tornillo", Direccion: "Av. Siempre Viva 742", Horario: "09:00 a 12:00", Bultos: 2 },
                    { N: "2", Destino: "Kiosco de la Esquina", Direccion: "San Martín 1234", Horario: "15:00 a 18:00", Bultos: 1 },
                    { N: "3", Destino: "Supermercado La Familia", Direccion: "Belgrano 890", Horario: "Todo el día", Bultos: 5 },
                ];
                const batch = writeBatch(db);
                initialData.forEach(reparto => batch.set(doc(repartosCollectionRef), reparto));
                await batch.commit();
                showToast("Datos de ejemplo cargados.", "success");
            });


            // --- 7. INITIALIZATION ---
            listenForRepartos();

        })();

    </script>
</body>
</html>


